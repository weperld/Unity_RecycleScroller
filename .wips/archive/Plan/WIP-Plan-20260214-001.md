# Plan 단계 독립 WIP

## 기본 정보
- **WorkID**: WIP-20260214-001
- **스테이지**: Plan
- **담당 에이전트**: analyst
- **생성일**: 2026-02-14
- **상태**: 완료

---

## 🔒 절대 규칙 준수 확인 (강제)

### analyst 절대 규칙 체크
- [x] 무조건 캐스팅 (Type)cast 남용하지 않음
- [x] GetComponent 호출 결과를 캐싱함
- [x] Update/LateUpdate에서 GC 유발 코드 없음
- [x] 빈 catch 블록이 없음
- [x] 에디터 코드가 런타임에 포함되지 않음 (#if UNITY_EDITOR)
- [x] Object Pool 사용 시 참조 정리 완료
- [x] 빈 catch 블록 없음
- [x] 테스트 삭제하지 않음
- [x] 커밋 없이 파일 수정하지 않음 (사용자 요청 전)
- [x] 단언 없이 추측하지 않음
- [x] 개발 파이프라인 지침을 파괴하지 않음
- [x] 모든 위반이 없음을 확인함

---

## 지시 정보

### 작업 대상 (Target)
- RecycleScrollbar의 핸들 사이즈 동적 조정 기능 구현
- 비루프 모드: Elastic 오버슈트 시 핸들 사이즈 축소 피드백
- 루프 모드: 3개 핸들 위치 이동 → 2개 핸들 사이즈 전환 방식으로 변경

### 변경 파일 (Files)
- `Packages/com.phjun.recyclescroller/Runtime/RecycleScroll/RecycleScrollbar.cs` (핵심 수정)
- `Packages/com.phjun.recyclescroller/Editor/Drawers/RecycleScrollbarDrawer.cs` (에디터 업데이트 가능)

### 필수 조건 (Requirements)
- 외부(RecycleScroller)에서 offset 전달 없이 value만으로 자체 처리
- IRecycleScrollbarDelegate 인터페이스 변경 최소화
- 비루프/루프 모드 모두 기존 스크롤 동작에 영향 없음
- Unity ScrollRect의 Elastic 핸들 축소 패턴 참고

---

## 작업 진행 내용

### 1단계: 확인 및 분석 (Confirm & Analyze)
- [x] 지시 내용 확인
- [x] 관련 파일 목록 파악
- [x] 기존 코드/문서 분석
- [x] 유형 판단 (신규 B)
- [x] 영향 범위 분석

### 2단계: 계획 (Plan)
- [x] 작업 계획 수립
- [x] 예상 변경 파일 정리
- [x] 위험 요소 식별
- [x] 사용자 확인 요청 준비

### 3단계: 실행 (Execute)
- [x] 계획 문서화
- [x] **수렴 분석**: 계획 결과물에 대한 보완 사항 도출
- [x] 보완 사항 분류 (필수/선택) 및 필수 보완 사항 반영
- [x] 수렴 확인: 필수 보완 사항 0건 달성
- [x] 잔존 선택 보완 사항 목록 기록
- [x] 사용자 확인 요청
- [x] 사용자 응답 기록: **승인 (y)**
- [x] Gate-1 검증 완료: **통과**

---

## 진척도
- **진척도**: 100%

---

## 분석 결과

### 유형 판단
- **유형**: 신규 B (새로운 기능 추가)
- **근거**: 기존에 없던 핸들 사이즈 동적 조정 기능을 새로 구현. RecycleScrollbar에 비루프 Elastic 피드백 + 루프 사이즈 전환이라는 새로운 시각적 동작 추가.

### 영향 분석
- **영향 파일**:
  - `RecycleScrollbar.cs` — 핵심 변경 (UpdateVisuals, UpdateLoopHandles, ResetSubHandlePosition, CreateHandles 등)
  - `RecycleScrollbarDrawer.cs` — 에디터 UI 업데이트 가능
- **위험도**: 중간
  - 비루프 모드: value 오버슈트 감지는 기존 Set() 로직과 호환 (클램프하지 않으므로)
  - 루프 모드: 서브 핸들 배치 방식이 근본적으로 바뀌므로 시각적 검증 필수

---

## 📋 새로운 기능 추가 계획

### 기능 개요
- **기능 이름**: Elastic 핸들 사이즈 조정
- **카테고리**: ScrollCore, LoopScroll
- **설명**: RecycleScrollbar에서 외부 offset 전달 없이 value만으로 핸들 사이즈를 동적으로 조정하는 기능

### 구현 상세

#### A. 비루프 모드 — Elastic 핸들 사이즈 축소

**원리**: value가 [0, 1] 범위를 벗어난 양(오버슈트)을 감지하여 핸들 사이즈를 동적으로 축소

**구현 위치**: `UpdateVisuals()` 내부

**로직**:
```
overValue = value < 0 ? Abs(value) : (value > 1 ? value - 1 : 0)
```
- overValue > 0이면 DisplaySize를 축소
- Unity ScrollRect 공식 참고: `size = Clamp01((ViewSize - Abs(offset)) / ContentSize)`
- RecycleScrollbar 변환: value 기반 오버슈트를 DisplaySize 축소에 매핑
- 핸들 위치는 기존대로 `Clamp01(value) * movementScale` 유지

**기존 동작과의 호환**:
- `Set()`에서 m_Value를 클램프하지 않으므로 오버슈트 값이 보존됨 ✅
- `UpdateDrag()`는 `Clamp01`로 설정하므로 직접 드래그는 영향 없음 ✅
- RecycleScroller의 `SetScrollbarValueWithoutNotify()`에서 `RealNormalizedScrollPosition`이 ScrollRect.normalizedPosition을 직접 사용하므로 Elastic 시 [0,1] 범위를 넘음 ✅

#### B. 루프 모드 — 핸들 사이즈 전환

**원리**: 3개 핸들 위치 이동 → 2개 핸들 사이즈 전환으로 변경

**현재 구조 (폐기 대상)**:
- 메인 핸들 + leftHandle + rightHandle이 등간격(±ScrollbarRectSize) 배치
- 3개가 일체로 이동, 마스크로 보이는 것만 표시

**새 구조**:
- 좌측 핸들: 스크롤바 시작 끝에 고정 앵커
- 우측 핸들: 스크롤바 끝 끝에 고정 앵커
- value(movement) 변화에 따라 좌/우 핸들 사이즈를 교차 변경
- 한쪽은 커지면서, 반대쪽은 줄어듦 → 루프 전환 효과

**동작 케이스** (수평 LeftToRight 기준):
- 케이스 1 (스크롤 →): 좌측 0→최대 증가, 우측 최대→0 감소
- 케이스 2 (스크롤 ←): 좌측 최대→0 감소, 우측 0→최대 증가

**변경 대상 메서드**:
- `UpdateVisuals()` — 루프 모드에서 메인 핸들 대신 좌/우 핸들 사이즈 제어
- `UpdateLoopHandles()` — 기존 sizeDelta 복사 로직 → 사이즈 전환 로직
- `ResetSubHandlePosition()` — 고정 오프셋 → 앵커 기반 고정 배치
- `CreateHandles()` — 서브 핸들 생성/부모 설정 변경 가능

### 위험 요소
1. **루프 모드 시각적 검증**: 사이즈 전환 방식이 기존 위치 이동과 동일한 UX를 제공하는지 실제 Unity 에디터에서 확인 필요
2. **Direction 다양성**: LeftToRight, RightToLeft, BottomToTop, TopToBottom 4가지 방향 모두 정상 동작해야 함
3. **FixedHandleSize 호환**: ~~충돌 우려~~ → **해소됨**: Elastic 오버슈트 시 FixedHandleSize 이하로도 축소 허용 (사용자 결정)
4. **메인 핸들 역할 변경**: 루프 모드에서 메인 핸들(handleRect)의 역할이 달라지므로 기존 드래그/클릭 로직과의 정합성 확인 필요

### 구현 순서
1. 비루프 모드: `UpdateVisuals()`에 value 오버슈트 기반 사이즈 축소 로직 추가
2. 루프 모드: 서브 핸들 배치 방식을 앵커 기반 고정으로 변경
3. 루프 모드: value 기반 사이즈 전환 로직 구현
4. 4방향(Direction) 테스트
5. FixedHandleSize 호환성 확인
6. 에디터 드로어 업데이트 (필요 시)

---

## 수렴 검증 결과

### 수렴 반복 #1
- **발견된 보완 사항**: 4건 (필수 1건 / 선택 3건)
- **필수 보완 사항**:
  1. FixedHandleSize vs Elastic 우선순위 — Elastic 오버슈트 시 FixedHandleSize 최소값 이하로도 축소되어야 하는가?
     → **사용자 결정**: FixedSize 이하로도 축소 허용. Elastic 오버슈트가 크면 FixedHandleSize 보장 없이 사이즈가 줄어든다.
     → **반영**: 계획의 위험 요소 #3 해소. 비루프 모드에서 overValue 기반 축소 시 FixedHandleSize 하한을 무시하는 것으로 확정.
- **선택 보완 사항**:
  1. value→사이즈 매핑 공식의 구체적 수식 — Design 단계에서 결정 (Plan에서는 "오버슈트 비례 축소" 원칙만 확정)
  2. 루프 모드에서 메인 핸들(handleRect) 역할 변경 시 드래그 영역 처리 — Design 단계에서 상세 설계
  3. 에디터 드로어 업데이트 범위 — Code 단계에서 필요 시 결정
- **결과**: 필수 보완 사항 반영 완료, **수렴 달성** (필수 0건)

---

## 크로스체크 결과

### analyst 자체 검증 (Gate-1)
- [x] 1차 검증 통과
- [x] 2차 검증 통과

### architect 크로스체크 (Gate-1)
- [x] 크로스체크 통과
- 상태: **통과**
- Design 인계 사항:
  1. (필수) 오버슈트 계산에 `m_Value` 직접 사용 (`value` getter는 stepped 반올림)
  2. (권고) Elastic 축소를 `DisplaySize` 프로퍼티가 아닌 `UpdateVisuals()` 내 로컬 계산으로 처리
  3. (권고) 루프 서브 핸들 부모 변경 시 앵커/피벗 설정 검증

---

## 완료/취소 정보

### 완료 시
- **완료일**: (완료 시 기록)
- **최종 진척도**: 100%

### 취소 시
- **취소일**: (취소 시 기록)
- **취소 사유**: (사유)
